### 单线程

如果不考虑并发问题，即同一时刻只有一个事务正在运行

那么，应该在每次插入数据和更新数据前，写入日志文件。 日志记录格式应该是
事务ID insert data
事务ID update old_data new_data

不考虑并发情况的前提下，日志记录中事务ID不会互相交叉
（事务ID1 insert data）
（事务ID1 update old_data new_data）
（事务ID2 insert data）
（事务ID3 update old_data new_data）
不会出现在事务ID1的两个记录之间，出现事务ID2记录的情况

在此情况下使用日志恢复需要按照如下步骤执行
假定日志中最后一个事务是事务ID3

1. 对事务ID3之前所有已完成的事务，进行重做（redo）
2. 对事务ID3之前所有未完成的事务，进行撤销（undo）

redo操作

1. 扫描日志，收集所有已完成事务
2. 正序执行
3. 如果日志记录是insert操作，则执行insert操作
4. 如果日志记录是update操作，则执行update操作

undo操作

1. 扫描日志，收集所有未完成事务
2. 倒序执行
3. 如果日志记录是insert操作，则执行删除操作
4. 如果日志记录是update操作，则将数据设置为旧值

### 多线程

需要满足两个条件

1. 正在进行的事务，不会读取其他任务未提交的事务产生的数据
2. 正在进行的事务，不会修改其他事务未提交的事务产生的数据

在保证这两个条件的前提下，恢复数据可以保持和单线程一致

1. redo所有已完成的事务
2. undo所有未完成的事务

至于如何保证这两个条件，通过两段锁协议和可串行化调度算法实现